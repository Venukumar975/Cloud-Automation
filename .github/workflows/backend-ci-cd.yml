name: Backend CI/CD

on:
  push:
    branches: ["main"]
    paths:
      - "App/backend_api/**"
      - ".github/**"
      - "config.json"

permissions:
  id-token: write
  contents: read

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup / Build Backend
        id: setup
        uses: ./.github/actions/setup
        with:
          app-id: source_1
          config-path: ./config.json

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: backend-ci

      - name: Get ECR repo URL from SSM
        id: ecr
        env:
          PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
        run: |
          REPO=$(aws ssm get-parameter \
            --name "/$PROJECT_NAME/ci/ecr/backend/repo" \
            --query "Parameter.Value" \
            --output text)
          echo "repo=$REPO" >> "$GITHUB_OUTPUT"

      - name: Login to ECR
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          REPO="${{ steps.ecr.outputs.repo }}"
          REGISTRY_HOST=$(echo "$REPO" | cut -d'/' -f1)

          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$REGISTRY_HOST"

      - name: Build & Push Docker Image
        id: build_and_push
        env:
          REPO: ${{ steps.ecr.outputs.repo }}
        run: |
          IMAGE_TAG="${GITHUB_SHA}"

          echo "Building image $REPO:$IMAGE_TAG from ${{ steps.setup.outputs.directory }}"

          docker build -t "$REPO:latest" "${{ steps.setup.outputs.directory }}"
          docker tag "$REPO:latest" "$REPO:$IMAGE_TAG"

          docker push "$REPO:latest"
          docker push "$REPO:$IMAGE_TAG"

          echo "image_uri=$REPO:$IMAGE_TAG" >> "$GITHUB_OUTPUT"

      - name: Update image URI in SSM
        env:
          PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
        run: |
          aws ssm put-parameter \
            --name "/$PROJECT_NAME/compute/backend/image_uri" \
            --value "${{ steps.build_and_push.outputs.image_uri }}" \
            --type String \
            --overwrite

      - name: Start instance refresh (zero-downtime)
        env:
          ASG_NAME: ${{ secrets.ASG_NAME }}
        run: |
          echo "Refreshing ASG: $ASG_NAME"
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "$ASG_NAME" \
            --strategy Rolling \
            --preferences '{"MinHealthyPercentage":80,"InstanceWarmup":60}'
