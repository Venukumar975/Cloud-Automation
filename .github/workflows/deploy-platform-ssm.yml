name: Deploy (Platform - SSM)

on:
  workflow_run:
    workflows: ["Backend CI"]
    types: [completed]

permissions:
  contents: read
  packages: read
  statuses: write
  id-token: write

env:
  SSM_PREFIX: /hosting-template/compute/backend
  CI_ECR_PREFIX: /hosting-template/ci/ecr/backend
  DEFAULT_AWS_REGION: ap-south-1

jobs:
  deploy-single-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS for deployment
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ${{ env.DEFAULT_AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: deploy-ssm

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Read service config from SSM (single-service)
        id: parse
        shell: bash
        run: |
          set -euo pipefail

          PREFIX="${{ env.SSM_PREFIX }}"

          # Keys we expect at /.../backend/<key>
          KEYS=(image_repo image_uri asg_name region port health_path instance_warmup min_healthy_percent user_data_template ssm_param_name)

          # Try to retrieve each key (silently empty if missing)
          for k in "${KEYS[@]}"; do
            P="${PREFIX}/${k}"
            V=$(aws ssm get-parameter --name "$P" --with-decryption --query 'Parameter.Value' --output text 2>/dev/null || echo "")
            echo "${k}=$V" >> $GITHUB_OUTPUT
          done

          # fallback: if image_repo missing, check CI prefix where CI writes the repo
          if [ -z "${{ steps.parse.outputs.image_repo }}" ] ; then
            CI_REPO_PARAM="${{ env.CI_ECR_PREFIX }}/repo"
            CI_REPO=$(aws ssm get-parameter --name "$CI_REPO_PARAM" --query 'Parameter.Value' --output text 2>/dev/null || echo "")
            if [ -n "$CI_REPO" ]; then
              echo "image_repo=$CI_REPO" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Debug module config
        run: |
          echo "image_repo: ${{ steps.parse.outputs.image_repo }}"
          echo "image_uri: ${{ steps.parse.outputs.image_uri }}"
          echo "asg_name : ${{ steps.parse.outputs.asg_name }}"
          echo "region   : ${{ steps.parse.outputs.region }}"
          echo "ssm_param_name: ${{ steps.parse.outputs.ssm_param_name }}"

      - name: Update SSM Param with new image
        id: ssm_update
        shell: bash
        run: |
          IMAGE="${{ steps.parse.outputs.image_repo }}:${{ github.sha }}"
          if [ -z "$IMAGE" ] || [[ "$IMAGE" == ":${{ github.sha }}" ]]; then
            echo "::error::image_repo is empty; cannot form image uri"
            exit 1
          fi

          TARGET="${{ steps.parse.outputs.ssm_param_name }}"
          if [ -z "$TARGET" ]; then
            TARGET="${{ env.SSM_PREFIX }}/image_uri"
          fi

          echo "Updating $TARGET -> $IMAGE"
          aws ssm put-parameter --name "$TARGET" --value "$IMAGE" --type String --overwrite
          echo "updated_param=$TARGET" >> $GITHUB_OUTPUT

      - name: Safe ASG refresh
        id: refresh
        shell: bash
        run: |
          ASG="${{ steps.parse.outputs.asg_name }}"
          if [ -z "$ASG" ]; then
            echo "No ASG configured, skipping instance refresh"
            echo "refresh_id=" >> $GITHUB_OUTPUT
            exit 0
          fi

          STATUS=$(aws autoscaling describe-instance-refreshes \
            --auto-scaling-group-name "$ASG" \
            --max-records 1 \
            --query 'InstanceRefreshes[0].Status' --output text 2>/dev/null || echo "NONE")

          if [ "$STATUS" = "InProgress" ]; then
            echo "Refresh already running"
            echo "refresh_id=" >> $GITHUB_OUTPUT
            exit 0
          fi

          RID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "$ASG" \
            --strategy Rolling \
            --query 'InstanceRefreshId' --output text)

          echo "refresh_id=$RID" >> $GITHUB_OUTPUT

      - name: Get previous stable version
        id: prev
        if: steps.refresh.outputs.refresh_id != ''
        shell: bash
        run: |
          PREFIX="${{ env.SSM_PREFIX }}"
          STABLE="${PREFIX}/stable_image_uri"
          PREV=$(aws ssm get-parameter --name "$STABLE" --query "Parameter.Value" --output text 2>/dev/null || echo "")
          echo "PREV_IMAGE=$PREV" >> $GITHUB_ENV
          CURRENT="${{ steps.parse.outputs.image_repo }}:${{ github.sha }}"
          echo "CURRENT_IMAGE=$CURRENT" >> $GITHUB_ENV

      - name: Wait for refresh
        id: wait
        if: steps.refresh.outputs.refresh_id != ''
        timeout-minutes: 60
        continue-on-error: true
        shell: bash
        run: |
          ASG="${{ steps.parse.outputs.asg_name }}"
          REF="${{ steps.refresh.outputs.refresh_id }}"

          for i in {1..120}; do
            S=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name "$ASG" \
              --instance-refresh-ids "$REF" \
              --query 'InstanceRefreshes[0].Status' \
              --output text)

            echo "Status: $S"

            if [ "$S" = "Successful" ]; then
              STABLE="${{ env.SSM_PREFIX }}/stable_image_uri"
              aws ssm put-parameter --name "$STABLE" --value "${{ env.CURRENT_IMAGE }}" --type String --overwrite
              exit 0
            fi

            if [[ "$S" =~ Failed|Cancelled|RollbackInProgress|RollbackFailed ]]; then
              exit 1
            fi

            sleep 30
          done

          exit 1

      - name: Rollback if needed
        if: steps.wait.outcome == 'failure' && env.PREV_IMAGE != ''
        shell: bash
        run: |
          TARGET="${{ env.SSM_PREFIX }}/image_uri"
          echo "Rollback to ${PREV_IMAGE}"
          aws ssm put-parameter --name "$TARGET" --value "${PREV_IMAGE}" --type String --overwrite

          ASG="${{ steps.parse.outputs.asg_name }}"
          [ -z "$ASG" ] || aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "$ASG" \
            --strategy Rolling

          exit 1

      - name: Smoke test
        if: steps.wait.outcome == 'success'
        run: |
          echo "Smoke test placeholder â€” OK"
